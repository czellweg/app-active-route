<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../polymer/lib/utils/flattened-nodes-observer.html">

<dom-module id="app-active-route">
  <template>
    <slot></slot>
  </template>
  <script>
    class AppActiveRoute extends Polymer.Element {
      static get is() { return 'app-active-route'; }
      static get properties() {
        return {
          route: {
            type: Object,
            readOnly: true,
            notify: true
          },
          pattern: {
            type: String,
            readOnly: true,
            notify: true,
            computed: '_computePattern(route)'
          },
          data: {
            type: Object,
            readOnly: true,
            notify: true,
            computed: '_computeData(route)'
          },
          tail: {
            type: Object,
            readOnly: true,
            notify: true,
            computed: '_computeTail(route)'
          },
          fallbackPattern: {
            type: String
          },
          fallbackData: {
            type: String
          },
          fallbackTail: {
            type: String
          },
          _routes: {
            type: Array
          }
        };
      }
      ready() {
        super.ready()

        this._routes = this.shadowRoot.querySelector('slot').assignedNodes();
        this._routes.forEach((node) => {
          if(node.nodeName.localeCompare('app-route') < 0) return;
          node.addEventListener('active-changed', () => this._handleActiveChanged(node));
          if (node.active) {
            this._setRoute(node);
          }
        });
        this._setRoute(this._routes.find((r) => r.active) || null);
      }
      _handleActiveChanged() {
        return this._setRoute(this._routes.find(function(r){ return r.active; }) || null);
      }
      _computePattern(route) {
        return route ? route.pattern : this.fallbackPattern;
      }
      _computeData(route) {
        return route ? route.data : this.fallbackData;
      }
      _computeTail(route) {
        return route ? route.tail : this.fallbackTail;
      }
    }

    window.customElements.define(AppActiveRoute.is, AppActiveRoute);
  </script>
</dom-module>
